namespace App.Services.Services
{
    using System;
    using System.Collections.Generic;
    using System.ComponentModel;
    using System.Linq;
    using System.Linq.Expressions;
    using System.Threading.Tasks;
    using App.Services.Commons;
    using global::AutoMapper;
    using global::Core.BC.Domain.Entities.checklistConfig;
    using global::Core.BC.Domain.Entities.checklistConfig.Commands;
    using global::Core.BC.Domain.Entities.checklistConfig.interfaces;
    using Interanet.Commons.App.Shared.Base;
    using Interanet.Commons.Core.Shared.Interfaces;
    using Interanet.Commons.Core.Shared.Interfaces.Commands;
    using Interanet.Commons.Core.Shared.Interfaces.Events;
    using Interanet.Commons.Core.Shared.Messages;
    using Interanet.Commons.Infra.Repository.Shared.Interfaces;
    using MediatR;
    using Microsoft.Extensions.Logging;
    using Newtonsoft.Json;

    public class ChecklistConfigServices : GenericServiceAbstract<ChecklistConfigModel>, IchecklistConfigServices
    {
        private readonly JsonSerializerSettings settings;
        private readonly IRepository<ChecklistConfigModel> _repository;

        public ChecklistConfigServices(
           IMapper mapper,
           IUnitOfWork uow,
           ILogger<ChecklistConfigModel> logger,
           IRepository<ChecklistConfigModel> repository,
           IDomainEventBus bus,
           INotificationHandler<Notification> notifications,
           INotificationHandler<CrossMessage> messages)
           : base(mapper, uow, bus, notifications, messages, logger, repository)
        {
            settings = new JsonSerializerSettings
            {
                ReferenceLoopHandling = ReferenceLoopHandling.Ignore
            };
            _repository = repository;
        }

        public override async Task<bool> AssertToCreate(ChecklistConfigModel data)
        {
            logger.LogInformation($"Dado passado para analise: {JsonConvert.SerializeObject(data)}");

            var _t = _repository.Get()
                .Where(x => x.BusinessUid.Equals(new Guid(user.ipRemote)) && x.removedAt == null
                && x.Name.ToLower().Equals(data.Name.ToLower()))
                .ToList();

            if (_t.Count > 0)
            {
                await bus.Raise(Notification.CreateError("Categoria ", "Essa Local ja existe"));
                return false;
            }

            data.BusinessUid = new Guid(user.ipRemote);

            return await base.AssertToCreate(data);
        }

        public async Task<bool> Update(ChecklistConfigModel data)
        {

            var _t = _repository.Get()
              .Where(x => !x.BusinessUid.Equals(new Guid(user.ipRemote)) && x.removedAt == null
              && x.Name.ToLower().Equals(data.Name.ToLower()))
              .ToList();

            if (_t.Count > 0)
            {
                await bus.Raise(Notification.CreateError("Categoria ", "Essa Local ja existe"));
                return false;
            }

            data.updatedAt = DateTime.Now;
            data.updatedPersonUid = user.personUid;
            data.IsUpdate = true;
            data.ToUpdated(user.userName, user.personUid);
            _repository.Save(data);
            await _repository.CommitChanges();

            return true;

        }

        public Task<ResponsePaginated<List<ChecklistConfigModel>>> Search(ChecklistConfigListCommand cmd)
        {

            var filter = PredicateExtensions.Begin<ChecklistConfigModel>();

            filter = filter.And(x => x.BusinessUid == this.user.businessUid && x.removedAt == null);

            if (cmd.Description != null && cmd.Description.Length > 0)
            {
                if (PredicateExtensions.CleanStringOfNonDigits_V1(cmd.Description).Length > 0)
                    filter = filter.And(x => x.Name.ToString().Contains(PredicateExtensions.CleanStringOfNonDigits_V1(cmd.Description)) || x.Name.Contains(cmd.Description));
                else
                    filter = filter.And(x => x.Name.Contains(cmd.Description));
            }

            return List(cmd, filter);
        }

        public List<ChecklistConfigModel> GetAll()
        {
            var _r = this._repository
                            .Get()
                            .Where(x => x.removedAt == null && x.businessUid.Value == user.businessParentUid)
                            .OrderBy(x => x.Name)
                            .Select(x => new ChecklistConfigModel
                            {
                                uid = x.uid,
                                Name = x.Name,
                                Question = x.Question,
                                Checklists = x.Checklists
                            })
                            .ToList();

            return _r;
        }

        public override Task<ResponsePaginated<List<ChecklistConfigModel>>> List(IListCommand cmd, Expression<Func<ChecklistConfigModel, bool>> filter)
        {

            PropertyDescriptor prop = default;

            if (cmd.ColumnOrder != default)
                prop = TypeDescriptor.GetProperties(typeof(ChecklistConfigModel)).Find(cmd.ColumnOrder, true);

            if (prop == default)
                prop = TypeDescriptor.GetProperties(typeof(ChecklistConfigModel)).Find("insertedAt", true);

            if (string.IsNullOrWhiteSpace(cmd.Order) || cmd.Order != "desc" && cmd.Order != "asc")
                cmd.Order = "desc";

            var query = repository.Get();

            if (filter != default)
                query = query.Where(filter);

            List<ChecklistConfigModel> data = query.OrderBy(q => q.Name).Take(cmd.PageSize * cmd.Page)
                .Skip(cmd.Page == 1 ? 0 : cmd.PageSize * (cmd.Page - 1))
                .ToList();

            int totalRows = query != null ? query.Count() : 0;
            var paginated = new ResponsePaginated<List<ChecklistConfigModel>>(data ?? new List<ChecklistConfigModel>(), cmd.Page, cmd.PageSize, totalRows);

            return Task.FromResult(paginated);

        }

        public List<ChecklistConfigModel> Parent(ChecklistConfigListCommand cmd)
        {
            var _isParent = _repository.Get().Where(x => x.removedAt == null);
            var _return = new List<ChecklistConfigModel>();
            if (_isParent.Count() == 0)
            {
                _return = _repository.Get()
                    .Where(x => x.removedAt == null && x.uid != cmd.Uid && x.BusinessUid.Equals(new Guid(user.ipRemote)))
                    .OrderBy(q => q.Name)
                    .ToList();
            }
            return _return;
        }
    }
}

