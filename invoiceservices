namespace Front.API.Controllers
{
    using System;
    using System.Threading.Tasks;
    using global::Core.BC.Domain.Entities.person;
    using global::Core.BC.Domain.Entities.person.Commands;
    using global::Core.BC.Domain.Entities.person.interfaces;
    using Interanet.Commons.Core.Shared.Interfaces;
    using Interanet.Commons.Core.Shared.Messages;
    using Interanet.Commons.Front.Shared.Base;
    using MediatR;
    using Microsoft.AspNetCore.Authorization;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.Extensions.Logging;
    using Swashbuckle.AspNetCore.Annotations;

    [Route("~/person")]
    [ApiExplorerSettings(GroupName = @"person")]
    [SwaggerTag("Api da Pessoas.")]
    public class PersonController : DefaultControllerAbstract<PersonModel>
    {
        private readonly IpersonServices _service;

        public PersonController(
            IAppService<PersonModel> service,
            ILogger<PersonModel> logger,
            INotificationHandler<Notification> notification)
            : base(service, logger, notification)
        {
            service.EnableUserAcl = true;
            this._service = (IpersonServices)service;
        }

        [HttpPost]
        [SwaggerOperation(
        Summary = "Insere  um novo registro",
        Description = "")]
        public async Task<IActionResult> Create(PersonBaseCommand cmd)
        {
            var response = await this.service.Create(cmd);

            return this.Response(response.IsValid ? response.Data : null, null, null);

        }

        [HttpPut]
        public async Task<IActionResult> Update(PersonUpdateCommand cmd)
        {
            var response = await this.service.Update(cmd);

            return this.Response(response.IsValid ? response.Data : null);
        }

        [HttpGet]
        [Route("{uid?}")]
        public override async Task<IActionResult> GetById([FromRoute] Guid uid, [FromHeader] Guid businessUid)
        {
            var app = (IpersonServices)this.service;
            return this.Response(app.GetByUid(uid), null);
        }

        [HttpPost]
        [Route("search")]
        public virtual async Task<IActionResult> Search(
           [FromBody] PersonListCommand cmd,
           [FromHeader] bool summary = false,
           [FromHeader] int pageSize = 10,
           [FromHeader] int page = 1,
           [FromHeader] string order = "asc",
           [FromHeader] string columnOrder = "InsertedAt"
           )
        {
            cmd.PageSize = pageSize;
            cmd.Order = order;
            cmd.ColumnOrder = columnOrder;
            cmd.summary = summary;
            var app = (IpersonServices)this.service;
            var response = await app.Search(cmd).ConfigureAwait(false);
            return this.Response(response.IsValid ? response : null, nameof(this.GetById), null);
        }

        [HttpPut]
        [Route("changepassword")]
        public async Task<IActionResult> ChangePassword(PersonUpdatePasswordCommand cmd)
        {
            var app = (IpersonServices)this.service;
            var response = await app.ChangePassword(cmd);
            return this.Response(response);
        }

        [HttpGet]
        [Route("state")]
        public virtual async Task<IActionResult> State()
        {
            var app = (IpersonServices)this.service;
            var response = await app.GetState();
            return this.Response(response);
        }

        [HttpGet]
        [Route("city/{data}")]
        public virtual async Task<IActionResult> City(string data)
        {

            var app = (IpersonServices)this.service;
            var response = await app.GetCity(data);
            return this.Response(response);
        }

        [HttpGet]
        [Route("zipCode/{data}")]
        public virtual async Task<IActionResult> ZipCode(string data)
        {

            var app = (IpersonServices)this.service;
            var response = await app.GetZipCode(data);
            return this.Response(response);
        }

        [HttpGet]
        [Route("cnpj/{cnpj}")]
        [AllowAnonymous]
        public async Task<IActionResult> GetCnpj(string cnpj)
        {
            var app = (IpersonServices)this.service;
            var response = await app.GetCnpj(cnpj);
            return this.Response(response, null);
        }

        [HttpGet]
        [Route("cpf/{cpf}")]
        public virtual async Task<IActionResult> GetCpf(string cpf)
        {

            var app = (IpersonServices)this.service;
            var response = await app.GetCpf(cpf);
            return this.Response(response);
        }

        [HttpGet]
        [AllowAnonymous]
        [Route("importExcel")]
        public async Task<IActionResult> Import()
        {
            var app = (IpersonServices)this.service;
            var response = await app.Import();
            return this.Response(response);
        }

        [HttpGet]
        [Route("all")]
        public async Task<IActionResult> All()
        {
            var app = (IpersonServices)this.service;
            var response = app.GetAll();
            return this.Response(response, null);
        }

        [HttpGet]
        [Route("allproviders")]
        public async Task<IActionResult> AllProviders()
        {
            var app = (IpersonServices)this.service;
            var response = app.GetAllProviders();
            return this.Response(response, null);
        }

        [HttpGet]
        [Route("employee")]
        public IActionResult Employee()
        {
            var app = (IpersonServices)this.service;
            var response = app.GetEmployee();
            return this.Response(response, null);
        }

        [HttpGet]
        [Route("number")]
        public IActionResult Number()
        {
            var app = (IpersonServices)this.service;
            var response = app.Number();
            return this.Response(response, null);
        }

        [HttpGet]
        [Route("banks")]
        public async Task<IActionResult> Banks()
        {
            var app = (IpersonServices)this.service;
            var response = await app.Banks().ConfigureAwait(false);
            return this.Response(response, null);
        }

        [HttpGet]
        [Route("birthday")]
        public async Task<IActionResult> Birthday()
        {
            var app = (IpersonServices)this.service;
            var response = await app.Birthday().ConfigureAwait(false);
            return this.Response(response, null);
        }

        [HttpGet]
        [Route("sendSchedule")]
        [AllowAnonymous]
        public async Task<IActionResult> SendSchedule() => this.Response(await this._service.SendBirthday().ConfigureAwait(false));

        [HttpPost]
        [Route("export/excel")]
        public virtual async Task<IActionResult> ExportExcel([FromBody] PersonListCommand cmd) => this.Response(await this._service.SearchExportExcel(cmd).ConfigureAwait(false), null);

        [HttpPost]
        [Route("export/pdv")]
        public virtual async Task<IActionResult> ExportPDV([FromBody] PersonListCommand cmd) => this.Response(await this._service.SearchExportPDV(cmd).ConfigureAwait(false), null);
    }
}
